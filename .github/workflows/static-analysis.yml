name: Static Analysis

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  static-analysis:
    name: Static Analysis (macOS)
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          brew update
          brew install cmake ninja eigen ceres-solver nlohmann-json googletest boost cli11 llvm cppcheck
          echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"
          echo "CMAKE_PREFIX_PATH=$(brew --prefix googletest):$(brew --prefix cli11):$(brew --prefix ceres-solver)" >> "$GITHUB_ENV"

      - name: Configure
        run: |
          cmake -S . -B build -G "Ninja" \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            ${CMAKE_PREFIX_PATH:+-DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH"}

      - name: Build
        run: |
          cmake --build build -j 2

      - name: Run clang-tidy
        run: |
          find src -name "*.cpp" -exec clang-tidy -p build {} \
            --checks="-*,readability-*,performance-*,modernize-*,bugprone-*,clang-analyzer-*" \
            --header-filter=".*calib.*" \; \
            || (echo "::error::clang-tidy found issues" && exit 1)

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --inconclusive --std=c++20 \
            --suppress=missingIncludeSystem --suppress=unusedFunction --suppress=missingInclude \
            --error-exitcode=1 \
            src/ include/ \
            || (echo "::error::cppcheck found issues" && exit 1)

  format-check:
    name: Code Formatting
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          brew update
          brew install clang-format

      - name: Check formatting
        run: |
          find src include apps -name "*.cpp" -o -name "*.h" | \
          xargs clang-format --dry-run --Werror --style=file \
          || (echo "::error::Code formatting issues found. Run 'find src include apps -name \"*.cpp\" -o -name \"*.h\" | xargs clang-format -i' to fix." && exit 1)
